name: Deploy PR (Label Triggered)

# 1. –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –Ω–∞ PR –≤–µ—à–∞—é—Ç –º–µ—Ç–∫—É
on:
  pull_request_target:
    types: [labeled]

jobs:
  deploy-pr:
    # 2. –ó–ê–©–ò–¢–ê: –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–µ—Ç–∫–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è 'deploy'
    if: contains(github.event.pull_request.labels.*.name, 'deploy')
    runs-on: ubuntu-latest
    
    steps:
      # 3. –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥ –∏–º–µ–Ω–Ω–æ –∏–∑ PR (–∞ –Ω–µ –∏–∑ main)
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests pydantic pyyaml

      # 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH (—Å–µ–∫—Ä–µ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–ª–∞–≥–æ–¥–∞—Ä—è pull_request_target)
      - name: Setup SSH Tunnel
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Create Tunnel
        run: |
          ssh -o StrictHostKeyChecking=no -f -N -L 8000:127.0.0.1:8000 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}
          echo "Tunnel opened to 8000"

      # 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å
      - name: Upload Course
        env:
          LMS_API_URL: http://127.0.0.1:8000
          LMS_API_TOKEN: ${{ secrets.LMS_API_TOKEN }}
        run: |
          echo "üöÄ Deploying PR #${{ github.event.pull_request.number }} from user ${{ github.event.pull_request.user.login }}"
          python runner.py *.zip
